<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- Prevent zoom & scaling -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>SMT Counter – Fixed Taps</title>

<style>
/* Global mobile tap behavior */
html, body {
    font-family: Arial, sans-serif;
    background: #eef4ff;
    padding: 25px;
    text-align: center;

    touch-action: manipulation;
    -ms-touch-action: manipulation;
    overscroll-behavior: none;
}

/* Headings */
h1 {
    color: #163f9a;
}

/* Instructions */
#instructions {
    max-width: 700px;
    margin: 0 auto;
}

/* Trial info */
#trialInfo {
    font-size: 20px;
    margin-top: 20px;
    font-weight: bold;
}

#tapCountDisplay {
    margin-top: 15px;
    font-size: 18px;
    color: #111;
}

/* Tap Button (critical for mobile) */
#tapButton {
    background: #4677ff;
    color: white;
    border: none;
    padding: 30px 70px;
    font-size: 26px;
    border-radius: 14px;
    margin-top: 40px;
    cursor: pointer;

    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
}

#tapButton:active {
    background: #6d90ff;
}

/* Results box */
#resultsBox {
    margin-top: 40px;
    padding: 20px;
    background: white;
    border-radius: 10px;
    display: none;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
</style>
</head>

<body>

<h1>Spontaneous Motor Tempo (SMT) Test</h1>

<div id="instructions">
    <p>You will complete <b>two tapping trials</b>.</p>
    <p>In each trial, tap the button <b>exactly 20 times</b> at a natural, comfortable pace.</p>
    <p>Do not follow a beat, music, or rhythm — just tap naturally.</p>
</div>

<div id="trialInfo">Current Trial: <span id="trialNum">1</span> / 2</div>
<div id="tapCountDisplay">Taps: <span id="tapCount">0</span> / 20</div>

<button id="tapButton">TAP</button>

<div id="resultsBox">
    <h2>Results</h2>
    <p id="trial1Out"></p>
    <p id="trial2Out"></p>
    <p id="avgOut"></p>
    <p><b>Copy the average BPM into your Google Form.</b></p>
</div>

<script>
/* ===============================
   MOBILE ZOOM & GESTURE BLOCKERS
   =============================== */

// Prevent double-tap zoom
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, { passive: false });

// Prevent iOS gesture zoom
document.addEventListener('gesturestart', function (e) {
    e.preventDefault();
});

/* ===============================
   SMT LOGIC
   =============================== */

const REQUIRED_TAPS = 20;

let currentTrial = 1;
let tapCount = 0;

let tapsTrial1 = [];
let tapsTrial2 = [];

const tapButton = document.getElementById("tapButton");
const tapCountDisplay = document.getElementById("tapCount");
const trialNumDisplay = document.getElementById("trialNum");
const resultsBox = document.getElementById("resultsBox");

// Handle tap (FAST + ACCURATE)
tapButton.addEventListener("pointerdown", (e) => {
    e.preventDefault(); // critical to stop zoom/ghost clicks

    const now = performance.now();

    if (currentTrial === 1) {
        tapsTrial1.push(now);
    } else if (currentTrial === 2) {
        tapsTrial2.push(now);
    }

    tapCount++;
    tapCountDisplay.textContent = tapCount;

    if (tapCount >= REQUIRED_TAPS) endTrial();
});

// End trial
function endTrial() {
    if (currentTrial === 1) {
        if (tapsTrial1.length < 4) {
            alert("Not enough taps detected. Restart Trial 1.");
            tapsTrial1 = [];
            tapCount = 0;
            tapCountDisplay.textContent = tapCount;
            return;
        }

        alert("Trial 1 complete! Click OK to begin Trial 2.");
        currentTrial = 2;
        tapCount = 0;
        trialNumDisplay.textContent = "2";
        tapCountDisplay.textContent = "0";

    } else if (currentTrial === 2) {
        if (tapsTrial2.length < 4) {
            alert("Not enough taps detected. Restart Trial 2.");
            tapsTrial2 = [];
            tapCount = 0;
            tapCountDisplay.textContent = tapCount;
            return;
        }

        showResults();
        tapButton.disabled = true;
    }
}

// Compute BPM
function computeBPM(timestamps) {
    let intervals = [];
    for (let i = 1; i < timestamps.length; i++) {
        intervals.push(timestamps[i] - timestamps[i - 1]);
    }
    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
    return Math.round(60000 / avgInterval);
}

// Display results
function showResults() {
    const bpm1 = computeBPM(tapsTrial1);
    const bpm2 = computeBPM(tapsTrial2);
    const avg = Math.round((bpm1 + bpm2) / 2);

    document.getElementById("trial1Out").textContent = `Trial 1 BPM: ${bpm1}`;
    document.getElementById("trial2Out").textContent = `Trial 2 BPM: ${bpm2}`;
    document.getElementById("avgOut").textContent = `Average BPM (use this): ${avg}`;

    resultsBox.style.display = "block";
}
</script>

</body>
</html>
